@using KandaEu.Volejbal.Contracts.Nastenka.Dto;
@using KandaEu.Volejbal.Web.WebApiClients;

@inject INastenkaWebApiClient NastenkaWebApiClient
@inject IOsobaWebApiClient OsobaWebApiClient

@page "/nastenka"

<h2>Vzkazy</h2>

<Loading State="LoadingState">
	<LoadingInProgress>
		<p><em>Načítám vzkazy...</em></p>
	</LoadingInProgress>
	<LoadingFailed>
		<p><em>Načtení vzkazů se nezdařilo.</em></p>
	</LoadingFailed>
</Loading>

@if ((State.AktivniOsoby != null) && (State.Vzkazy != null))
{
	if (State.Vzkazy.Vzkazy.Count == 0)
	{
		<p>Na nástěnce není žádný aktuální vzkaz.</p>
	}
	else
	{
		foreach (var vzkaz in State.Vzkazy.Vzkazy)
		{
			<blockquote>
				<small>@vzkaz.Author dne @vzkaz.DatumVlozeni.DateTime.ToShortDateString() v @vzkaz.DatumVlozeni.DateTime.ToShortTimeString()</small>
				<p>@vzkaz.Zprava</p>
			</blockquote>
			<div>&nbsp;</div>
		}
	}

	<h2 class="icon-plus-2">Přidat vzkaz</h2>

	<EditForm Model="@formData" OnValidSubmit="OnValidSubmitAsync">
		<ValidationSummary />
		<DataAnnotationsValidator />

		<h3>Kdo</h3>
		<div class="input-control select">
			<InputSelectNumber @bind-Value="@formData.AutorId" style="width:20em;">
				<option value="" selected="selected">---</option>
				@if (State.AktivniOsoby != null)
				{
					@foreach (var osoba in State.AktivniOsoby.Osoby)
					{
						<option value="@osoba.Id">@osoba.PrijmeniJmeno</option>
					}
				}
			</InputSelectNumber>
		</div>

		<h3>Vzkaz</h3>
		<div class="input-control textarea">
			<span></span>
			<InputTextArea @bind-Value="@formData.Zprava" rows="5" cols="20" style="width:30em;" />
		</div>

		<input type="submit" value="přidat vzkaz" class="bg-color-red fg-color-white" />

	</EditForm>
}

@code
{
	private NastenkaFormData formData = new NastenkaFormData();
	private LoadingState LoadingState = new LoadingState();
	private NastenkaState State = new NastenkaState();

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();
		await LoadDataAsync();
	}

	private async Task OnValidSubmitAsync()
	{
		// TODO: Sdílení Contracts!		
		await NastenkaWebApiClient.VlozVzkazAsync(new WebApiClients.VzkazInputDto { AutorId = formData.AutorId.Value, Zprava = formData.Zprava });
		formData.Zprava = ""; // vyčistit formulář
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		State.AktivniOsoby = null;
		State.Vzkazy = null;
		try
		{
			LoadingState.LoadingInProgress = true;
			State.AktivniOsoby = await OsobaWebApiClient.GetAktivniOsobyAsync();
			State.Vzkazy = await NastenkaWebApiClient.GetVzkazyAsync();
		}
		catch
		{
			LoadingState.LoadingFailed = true;
		}
		finally
		{
			LoadingState.LoadingInProgress = false;
		}
	}
}